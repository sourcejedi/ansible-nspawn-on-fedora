- name: RedHat-compatible sudo package?
  when: ansible_os_family == "RedHat"
  set_fact: sudo_group="wheel"

- name: Debian-compatible sudo package?
  when: ansible_os_family == "Debian"
  set_fact: sudo_group="sudo"

- name: Test operating system is supported
  assert:
    that: sudo_group is defined

#- name: Install sudo
#  package: name=sudo state=present

# TODO debian sudo configuration

- user:
    state: present
    name:      '{{ item.name }}'
    comment:   '{{ item.comment | d(omit) }}'

    # Debian /etc/default/useradd: 'we use "sh" here because
    # useradd is a low level utility and should be as general
    # as possible'.
    # So we're also missing out on /etc/skel?
    shell: /bin/bash

    # sudo group
    # sshlogin group - see roles/openssh-server
    append: true
    groups: '{{
              ([sudo_group]  if item.sudo    | d(false) else []) +
              (["sshlogin"]  if item.sshkey  | d(false) else []) +
              []
            }}'
  with_items: '{{ users }}'
  loop_control:
    label: "{{ item.name }}"

- name: ssh authorized keys
  authorized_key:
    exclusive: yes  # replace existing key, when it is changed
    user: "{{ item.name }}"
    key: "{{ item.sshkey }}"
  with_items: "{{ users }}"
  when: item.sshkey is defined
  loop_control:
    label: "{{ item.name }}"

